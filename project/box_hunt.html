<!DOCTYPE html>
<html>
  <head>
    <style>
       /* Set the size of the div element that contains the map */
      #map {
        height: 400px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }
    </style>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body>
    <!-- TEMP STORAGE FOR USER-->
    <input type='hidden' id='current' value='Michelle'>
    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light ">
      <a class="navbar-brand" href="#">GeoHunt</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-item nav-link" href="dashboard.html">Home</a>
          <a class="nav-item nav-link" href="order.html">Rewards Shop</a>
          <a class="nav-item nav-link active" href="box_hunt.html">Box Hunt</a>
          <a class="nav-item nav-link" href="leaderboard.html">Leaderboards</a>
          <a id="paying" class="nav-item nav-link active" href="payment.html">Buy Membership</a>
        </div>
      </div>
    </nav>

    <h3>Geo Hunt Map</h3>
    <!--The div element for the map -->
    <div id="map">

    </div>
    
    <script>
       let box_URL = "http://localhost:5002/getBoxes";
        // Initialize and add the map
        
        function initMap() {
          // Initializing Treasure box Icon
          var treasure = {
            url:'img/treasure.png',
            scaledSize: new google.maps.Size(50, 50), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(0, 0) // anchor
          }
          //default starting location
         var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 1.2983, lng: 103.8487},
          zoom: 12
        });
        async function retrieveBoxes() {
         try {
           const response = await fetch(
             box_URL, {method: 'GET'}
           );

           if (!response.ok) {
             console.log("Error while retrieving boxes.")
           }
           else {
             var box_data = await response.json();
             console.log(box_data);
             for (box of box_data.boxes) {
               console.log(box);
              const LatLng = { lat: parseFloat(box.box_latitude), lng: parseFloat(box.box_longitude) };
              console.log(LatLng);
              new google.maps.Marker({
                position: LatLng,
                icon: treasure,
                map,
                title: box.planted_by_username,
              });
        }
           }
         }
         catch(error) {
           console.log("Error occurred before retrieving boxes: " + error)
         }
       }
       retrieveBoxes();

        
        //get user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            var posJSON = JSON.stringify(pos)


          
            //set user location
          map.setCenter(pos);
            
           //get marker 
          var marker = new google.maps.Marker({position: pos, map: map});
            

          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else { // error handling
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        
      }

      
        
      
    </script>

    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key 
    * The callback parameter executes the initMap() function
    -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQlWfUfcqz1MOyNdZRo-IG2vWh_2HT0Ko&callback=initMap">
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
  </body>
</html>