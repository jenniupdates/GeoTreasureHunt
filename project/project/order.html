<html>
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Ensures optimal rendering on mobile devices. -->
      <meta http-equiv="X-UA-Compatible" content="IE=edge" /> <!-- Optimal Internet Explorer compatibility -->
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
   <body>
      <h1>Geo Shop. Buy now!</h1>
      <div id='notice' style='color:red;'></div>
      <div id='success' style='color:green;'></div>
      <form id='form' action = "#" method = "post">
         <table border='1'>
            <tr>
               <th>Item</th>
               <th>Description</th>
               <th>Price</th>
               <th>Quantity</th>
            </tr>
            <tbody id='sale_table'></tbody>
            <tr>
               <td colspan='3' style='font-weight:bold;'><span id='subtotal'></span></td>
               <td> <input id='btn' type='submit' value='Purchase' onclick='formSubmit()'> </td>
            </tr>
         </table>
      </form>   
   </body>
   <script>
      var item_list = [];
      async function getItems() {
         var shop_url = 'http://localhost:5005/getitems';
         try {
            const response = 
               await fetch(
                  shop_url, {method: 'GET'}
               );
            
               if (!response.ok) {
                  $('#notice').text("There was an error retrieving shop items");
               }
               else {
                  const shop_items = await response.json();
                  //console.log(shop_items);
                  for (i=0; i<shop_items.shop_items.length; i++) {
                     item_list.push(shop_items.shop_items[i].itemname);
                     document.getElementById("sale_table").innerHTML += 
                     `<tr>
                        <td>`+shop_items.shop_items[i].itemname+`</td>
                        <td>`+shop_items.shop_items[i].description+`</td>
                        <td>`+shop_items.shop_items[i].price+`</td>
                        <td style='text-align:center;'> <select id='`+shop_items.shop_items[i].itemname+`'>
                              <option value='0'>0</option>
                              <option value='1'>1</option>
                              <option value='2'>2</option>
                              <option value='3'>3</option>
                              <option value='4'>4</option>
                              <option value='5'>5</option>
                             </select>
                        </td>
                     </tr>`;
                  }

               }
         }
         catch(error) {
            $('#notice').text("There was an error retrieving shop items" + error);
         }
      };
      getItems();

      document.getElementById("btn").addEventListener("click", function(event){
         event.preventDefault()
      });

      // When form is submitted.
      function formSubmit() {
         $('#notice').text("");
         $('#success').text("")
         cart_data = {"data": [] }
         let form = document.getElementById("form").elements;
         //console.log(form);
         for (j=0;j<form.length-1;j++) {
            // console.log(form[j].id)
            // console.log(form[j].value)
            if (form[j].value > 0) {
               let chosen_item = form[j].id;
               let qty = form[j].value;
               cart_data['data'].push({ "item" : chosen_item, "quantity": qty });
            }
         }
         console.log(cart_data);
         if (cart_data['data'] == []) {
            $('#notice').text("Your cart is empty!")
         }
         else {
            order_url = 'http://localhost:5007/order';
            cart_json = JSON.stringify(cart_data);
            async function send_order() {
               try {
                  const response = await fetch(
                     (order_url),
                     {
                        method: 'POST',
                        headers: {
                           "Content-type": "application/json"
                        },
                        body: cart_json
                     }
                  );

                  if (!response.ok) {
                     $('#notice').text("An error occurred while processing your purchase.")
                  }
                  else {
                     const data = await response.json();
                     console.log(data);
                     if (data.code == 201) {
                        $('#success').text("Your purchase has been successful. Your items have been added to your inventory.")
                     }
                     else if (data.code == 500) {
                        $('#notice').text("You do not have enough points purchase. Remove some items from your cart!")
                     }
                     else if (data.code == 404) {
                        $('#notice').text("Your cart is empty!")
                     }

                  }
               }
               catch (error) {
                  $('#notice').text("An error occurred: " + error)
               }
            }
            send_order();

         }
         



      }
      
   </script>
</html>